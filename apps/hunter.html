<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jäger-Orientierung</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #3a3a3a;
            color: #f0f0f0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            touch-action: none;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
            width: 100%;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 14px;
            color: #b0b0b0;
        }
        
        .compass-container {
            position: relative;
            width: 100%;
            padding-bottom: 100%;
            margin-bottom: 20px;
        }
        
        .compass {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: #2a2a2a;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .compass-rose {
            position: absolute;
            width: 90%;
            height: 90%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><circle cx="100" cy="100" r="98" fill="none" stroke="%23444" stroke-width="1"/><path d="M100,10 L100,30 M100,170 L100,190 M10,100 L30,100 M170,100 L190,100" stroke="%23666" stroke-width="1"/><path d="M100,2 L100,40 M100,160 L100,198 M2,100 L40,100 M160,100 L198,100" stroke="%23888" stroke-width="2"/><text x="100" y="15" text-anchor="middle" fill="%23ff5555" font-family="sans-serif" font-size="12">N</text><text x="100" y="195" text-anchor="middle" fill="%23aaaaaa" font-family="sans-serif" font-size="12">S</text><text x="15" y="103" text-anchor="middle" fill="%23aaaaaa" font-family="sans-serif" font-size="12">W</text><text x="185" y="103" text-anchor="middle" fill="%23aaaaaa" font-family="sans-serif" font-size="12">E</text></svg>');
            background-size: contain;
            transition: transform 0.2s ease-out;
        }
        
        .direction-pointer {
            position: absolute;
            top: 50%;
            width: 90%;
            height: 2px;
            background: linear-gradient(to right, transparent, #ff5555, #ff5555, #ff5555);
            transform-origin: center left;
            z-index: 100;
        }
        
        .current-direction {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 36px;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }
        
        .distance-container {
            margin: 20px 0;
        }
        
        .distance-label {
            display: block;
            margin-bottom: 10px;
            font-size: 16px;
            color: #b0b0b0;
        }
        
        .spinner-container {
            position: relative;
            height: 120px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            max-width: 300px;
            background-color: #2a2a2a;
            border-radius: 10px;
        }
        
        .spinner-wheel {
            position: absolute;
            width: 100%;
            text-align: center;
            transition: transform 0.1s ease-out;
        }
        
        .spinner-item {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: #aaa;
        }
        
        .spinner-selection {
            position: absolute;
            width: 100%;
            height: 40px;
            border-top: 2px solid #ff5555;
            border-bottom: 2px solid #ff5555;
            pointer-events: none;
        }
        
        .selected-distance {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
            font-size: 20px;
            font-weight: bold;
        }
        
        .selected-distance span {
            margin-left: 5px;
            color: #ff5555;
        }
        
        .action-buttons {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .primary-button {
            background-color: #ff5555;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .primary-button:hover {
            background-color: #ff3333;
        }
        
        .primary-button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }
        
        .secondary-button {
            background-color: #444;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .secondary-button:hover {
            background-color: #555;
        }
        
        .result-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #2a2a2a;
            border-radius: 8px;
            display: none;
        }
        
        .result-container h2 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #ff5555;
        }
        
        .result-item {
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .result-item strong {
            color: #b0b0b0;
            margin-right: 5px;
        }
        
        .result-item span {
            font-weight: bold;
        }
        
        .status-message {
            font-size: 14px;
            color: #b0b0b0;
            text-align: center;
            margin-top: 10px;
        }
        
        .highlight {
            color: #ff5555;
            font-weight: bold;
        }

        .center-dot {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: #ff5555;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>Jäger-Orientierung</h1>
            <p>Zeigen Sie in die Schussrichtung und geben Sie die Entfernung ein</p>
        </div>
        
        <div class="compass-container">
            <div class="compass">
                <div class="compass-rose" id="compassRose"></div>
                <div class="direction-pointer"></div>
                <div class="center-dot"></div>
                <div class="current-direction" id="currentDirection">0°</div>
            </div>
        </div>
        
        <div class="distance-container">
            <label class="distance-label">Entfernung zum Wild (in Metern):</label>
            <div class="spinner-container" id="spinnerContainer">
                <div class="spinner-wheel" id="spinnerWheel">
                    <!-- Spinner items will be generated by JavaScript -->
                </div>
                <div class="spinner-selection"></div>
            </div>
            <div class="selected-distance">Ausgewählt: <span id="selectedDistance">100</span> m</div>
        </div>
        
        <div class="action-buttons">
            <button class="primary-button" id="markButton">Position markieren</button>
            <button class="secondary-button" id="resetButton">Zurücksetzen</button>
        </div>
        
        <div class="result-container" id="resultContainer">
            <h2>Markierte Position</h2>
            <div class="result-item">
                <strong>Aktueller Standort:</strong> <span id="currentLocation">Wird ermittelt...</span>
            </div>
            <div class="result-item">
                <strong>Richtung:</strong> <span id="resultDirection">0°</span>
            </div>
            <div class="result-item">
                <strong>Entfernung:</strong> <span id="resultDistance">0</span> m
            </div>
            <div class="result-item">
                <strong>Zielposition:</strong> <span id="targetLocation">Nicht berechnet</span>
            </div>
        </div>
        
        <div class="status-message" id="statusMessage">
            Bitte <span class="highlight">erlauben</span> Sie den Zugriff auf Standort und Orientierung
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const compassRose = document.getElementById('compassRose');
            const currentDirection = document.getElementById('currentDirection');
            const spinnerWheel = document.getElementById('spinnerWheel');
            const spinnerContainer = document.getElementById('spinnerContainer');
            const selectedDistance = document.getElementById('selectedDistance');
            const markButton = document.getElementById('markButton');
            const resetButton = document.getElementById('resetButton');
            const resultContainer = document.getElementById('resultContainer');
            const currentLocation = document.getElementById('currentLocation');
            const resultDirection = document.getElementById('resultDirection');
            const resultDistance = document.getElementById('resultDistance');
            const targetLocation = document.getElementById('targetLocation');
            const statusMessage = document.getElementById('statusMessage');
            
            // App state
            let deviceOrientation = {
                absolute: false,
                alpha: 0,
                beta: 0,
                gamma: 0
            };
            let currentHeading = 0;
            let currentPosition = null;
            let selectedDistanceValue = 100;
            let compassAvailable = false;
            let geoLocationAvailable = false;
            
            // Initialize spinner wheel
            function initSpinnerWheel() {
                // Clear existing items
                spinnerWheel.innerHTML = '';
                
                // Generate distance options from 5m to 500m
                for (let i = 5; i <= 500; i += 5) {
                    const item = document.createElement('div');
                    item.className = 'spinner-item';
                    item.textContent = i;
                    item.dataset.value = i;
                    spinnerWheel.appendChild(item);
                }
                
                // Set initial position
                updateSpinnerPosition(selectedDistanceValue);
            }
            
            // Update spinner position based on selected value
            function updateSpinnerPosition(value) {
                const items = Array.from(spinnerWheel.children);
                const itemHeight = 40; // Same as in CSS
                const index = items.findIndex(item => parseInt(item.dataset.value) === value);
                
                if (index !== -1) {
                    const centerOffset = (spinnerContainer.clientHeight - itemHeight) / 2;
                    const y = -(index * itemHeight) + centerOffset;
                    spinnerWheel.style.transform = `translateY(${y}px)`;
                    selectedDistance.textContent = value;
                    selectedDistanceValue = value;
                }
            }
            
            // Initialize spinner touch/mouse controls
            function initSpinnerControls() {
                let startY = 0;
                let currentY = 0;
                let initialOffset = 0;
                
                spinnerContainer.addEventListener('mousedown', startDrag);
                spinnerContainer.addEventListener('touchstart', startDrag, { passive: false });
                
                function startDrag(e) {
                    e.preventDefault();
                    startY = e.type === 'mousedown' ? e.clientY : e.touches[0].clientY;
                    initialOffset = parseFloat(spinnerWheel.style.transform.replace('translateY(', '').replace('px)', '') || 0);
                    
                    document.addEventListener('mousemove', drag);
                    document.addEventListener('touchmove', drag, { passive: false });
                    document.addEventListener('mouseup', stopDrag);
                    document.addEventListener('touchend', stopDrag);
                }
                
                function drag(e) {
                    e.preventDefault();
                    currentY = e.type === 'mousemove' ? e.clientY : e.touches[0].clientY;
                    const deltaY = currentY - startY;
                    let newOffset = initialOffset + deltaY;
                    
                    spinnerWheel.style.transform = `translateY(${newOffset}px)`;
                }
                
                function stopDrag() {
                    document.removeEventListener('mousemove', drag);
                    document.removeEventListener('touchmove', drag);
                    document.removeEventListener('mouseup', stopDrag);
                    document.removeEventListener('touchend', stopDrag);
                    
                    // Find closest value
                    const transform = spinnerWheel.style.transform;
                    const currentOffset = parseFloat(transform.replace('translateY(', '').replace('px)', ''));
                    const itemHeight = 40;
                    const centerOffset = (spinnerContainer.clientHeight - itemHeight) / 2;
                    
                    // Calculate which item is closest to center
                    const index = Math.round((centerOffset - currentOffset) / itemHeight);
                    const items = Array.from(spinnerWheel.children);
                    
                    if (index >= 0 && index < items.length) {
                        const value = parseInt(items[index].dataset.value);
                        updateSpinnerPosition(value);
                    }
                }
            }
            
            // Initialize device orientation and compass
            function initDeviceOrientation() {
                if (window.DeviceOrientationEvent) {
                    // For iOS 13+ we need to request permission
                    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                        statusMessage.innerHTML = 'Bitte tippen Sie auf <span class="highlight">Standort markieren</span>, um Zugriff auf Orientierung zu erlauben';
                        
                        markButton.addEventListener('click', function requestOrientationAccess() {
                            DeviceOrientationEvent.requestPermission()
                                .then(permissionState => {
                                    if (permissionState === 'granted') {
                                        window.addEventListener('deviceorientation', handleOrientation);
                                        compassAvailable = true;
                                        statusMessage.textContent = 'Orientierung verfügbar';
                                        markButton.removeEventListener('click', requestOrientationAccess);
                                        initGeolocation();
                                    } else {
                                        statusMessage.innerHTML = '<span class="highlight">Zugriff verweigert</span> - Simulation aktiv';
                                        simulateCompass();
                                    }
                                })
                                .catch(console.error);
                        });
                    } else {
                        // Non-iOS or older iOS devices
                        window.addEventListener('deviceorientation', handleOrientation);
                        compassAvailable = true;
                        statusMessage.textContent = 'Orientierung verfügbar';
                        initGeolocation();
                    }
                } else {
                    statusMessage.innerHTML = '<span class="highlight">Kompass nicht verfügbar</span> - Simulation aktiv';
                    simulateCompass();
                }
            }
            
            // Simulate compass for desktop testing
            function simulateCompass() {
                compassAvailable = true;
                
                // Allow manual rotation with mouse/touch on compass
                const compass = document.querySelector('.compass');
                let startAngle = 0;
                let currentAngle = 0;
                
                compass.addEventListener('mousedown', startRotate);
                compass.addEventListener('touchstart', startRotate, { passive: false });
                
                function startRotate(e) {
                    e.preventDefault();
                    const rect = compass.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    
                    const x = e.type === 'mousedown' ? e.clientX : e.touches[0].clientX;
                    const y = e.type === 'mousedown' ? e.clientY : e.touches[0].clientY;
                    
                    startAngle = Math.atan2(y - centerY, x - centerX) * 180 / Math.PI;
                    
                    document.addEventListener('mousemove', rotate);
                    document.addEventListener('touchmove', rotate, { passive: false });
                    document.addEventListener('mouseup', stopRotate);
                    document.addEventListener('touchend', stopRotate);
                }
                
                function rotate(e) {
                    e.preventDefault();
                    const rect = compass.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    
                    const x = e.type === 'mousemove' ? e.clientX : e.touches[0].clientX;
                    const y = e.type === 'mousemove' ? e.clientY : e.touches[0].clientY;
                    
                    currentAngle = Math.atan2(y - centerY, x - centerX) * 180 / Math.PI;
                    const rotation = currentAngle - startAngle;
                    
                    // Update simulated compass
                    currentHeading = (currentHeading + rotation + 360) % 360;
                    updateCompassDisplay(currentHeading);
                    
                    startAngle = currentAngle;
                }
                
                function stopRotate() {
                    document.removeEventListener('mousemove', rotate);
                    document.removeEventListener('touchmove', rotate);
                    document.removeEventListener('mouseup', stopRotate);
                    document.removeEventListener('touchend', stopRotate);
                }
                
                // Initialize geolocation
                initGeolocation();
            }
            
            // Handle device orientation changes
            function handleOrientation(event) {
                deviceOrientation = event;
                
                // Calculate compass heading
                if (event.alpha !== null) {
                    let heading = event.alpha;
                    
                    // Adjust for device orientation
                    if (event.webkitCompassHeading) {
                        // iOS devices
                        heading = 360 - event.webkitCompassHeading;
                    } else if (window.orientation) {
                        // Adjust for screen orientation
                        switch (window.orientation) {
                            case 0:   break; // Portrait-primary
                            case 90:  heading = (heading + 90) % 360; break; // Landscape-primary
                            case -90: heading = (heading - 90 + 360) % 360; break; // Landscape-secondary
                            case 180: heading = (heading + 180) % 360; break; // Portrait-secondary
                        }
                    }
                    
                    currentHeading = heading;
                    updateCompassDisplay(currentHeading);
                }
            }
            
            // Update compass display
            function updateCompassDisplay(heading) {
                // Rotate compass rose in opposite direction
                compassRose.style.transform = `rotate(${-heading}deg)`;
                
                // Display heading
                const displayHeading = Math.round(heading);
                currentDirection.textContent = displayHeading + '°';
            }
            
            // Initialize geolocation
            function initGeolocation() {
                if (navigator.geolocation) {
                    const options = {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    };
                    
                    navigator.geolocation.watchPosition(
                        handlePositionSuccess,
                        handlePositionError,
                        options
                    );
                    
                    statusMessage.innerHTML = statusMessage.innerHTML + '<br>Standort wird ermittelt...';
                } else {
                    statusMessage.innerHTML += '<br><span class="highlight">Standort nicht verfügbar</span> - Simulation aktiv';
                    simulateGeolocation();
                }
            }
            
            // Handle successful geolocation
            function handlePositionSuccess(position) {
                currentPosition = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    accuracy: position.coords.accuracy
                };
                
                geoLocationAvailable = true;
                
                // Update status
                statusMessage.textContent = `Bereit. GPS-Genauigkeit: ±${Math.round(currentPosition.accuracy)}m`;
                
                // Enable mark button
                markButton.disabled = false;
                
                // Update location display
                currentLocation.textContent = `${currentPosition.latitude.toFixed(6)}, ${currentPosition.longitude.toFixed(6)}`;
            }
            
            // Handle geolocation error
            function handlePositionError(error) {
                console.error('Geolocation error:', error);
                statusMessage.innerHTML = `<span class="highlight">Standortfehler:</span> ${error.message} - Simulation aktiv`;
                simulateGeolocation();
            }
            
            // Simulate geolocation for testing
            function simulateGeolocation() {
                // Simulate a position in Germany
                currentPosition = {
                    latitude: 51.165691, // Example: Berlin
                    longitude: 10.451526,
                    accuracy: 10
                };
                
                geoLocationAvailable = true;
                
                // Update status
                statusMessage.textContent = 'Bereit (Simulierter Standort)';
                
                // Enable mark button
                markButton.disabled = false;
                
                // Update location display
                currentLocation.textContent = `${currentPosition.latitude.toFixed(6)}, ${currentPosition.longitude.toFixed(6)}`;
            }
            
            // Calculate target position based on heading, distance and current position
            function calculateTargetPosition(startPos, heading, distance) {
                // Earth's radius in meters
                const R = 6371000;
                
                // Convert to radians
                const lat1 = startPos.latitude * Math.PI / 180;
                const lon1 = startPos.longitude * Math.PI / 180;
                const bearing = heading * Math.PI / 180;
                
                // Distance in km
                const distKm = distance / 1000;
                
                // Calculate new position
                const lat2 = Math.asin(
                    Math.sin(lat1) * Math.cos(distKm / R) +
                    Math.cos(lat1) * Math.sin(distKm / R) * Math.cos(bearing)
                );
                
                const lon2 = lon1 + Math.atan2(
                    Math.sin(bearing) * Math.sin(distKm / R) * Math.cos(lat1),
                    Math.cos(distKm / R) - Math.sin(lat1) * Math.sin(lat2)
                );
                
                // Convert back to degrees
                return {
                    latitude: lat2 * 180 / Math.PI,
                    longitude: lon2 * 180 / Math.PI
                };
            }
            
            // Mark button click handler
            markButton.addEventListener('click', function() {
                if (compassAvailable && geoLocationAvailable) {
                    // Calculate target position
                    const target = calculateTargetPosition(
                        currentPosition,
                        currentHeading,
                        selectedDistanceValue
                    );
                    
                    // Update result display
                    resultDirection.textContent = Math.round(currentHeading) + '°';
                    resultDistance.textContent = selectedDistanceValue;
                    targetLocation.textContent = `${target.latitude.toFixed(6)}, ${target.longitude.toFixed(6)}`;
                    
                    // Show result container
                    resultContainer.style.display = 'block';
                    
                    // Update status
                    statusMessage.textContent = 'Position markiert!';
                }
            });
            
            // Reset button click handler
            resetButton.addEventListener('click', function() {
                // Hide result container
                resultContainer.style.display = 'none';
                
                // Update status
                statusMessage.textContent = 'Bereit für neue Markierung';
            });
            
            // Initialize app
            function initApp() {
                initSpinnerWheel();
                initSpinnerControls();
                initDeviceOrientation();
                
                // Disable mark button initially
                markButton.disabled = true;
            }
            
            // Start the app
            initApp();
        });
    </script>
</body>
</html>